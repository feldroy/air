# .github/workflows/CI.yml
# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# CI using uv + just, with minimal/noise-free logs:
# - Colors forced inside a tiny wrapper script (not via step `env:`), so they don’t appear in the log header.
# - No echo/group commands shown.
# - Shared bootstrap steps are DRY via YAML anchors.

name: CI

on:
  push:
    branches: [main]
    tags:
      - '*' # matches any tag name
  pull_request:
    branches: [main]

env:
  COLUMNS: 150
  CI: 1
  FORCE_COLOR: 1
  RUFF_OUTPUT_FORMAT: github
  RUFF_NO_CACHE: true
  JUST_COLOR: always
  JUST_COMMAND_COLOR: purple
  JUST_EXPLAIN: true
  JUST_HIGHLIGHT: true

# Cancel older runs for the same branch/PR (concurrency = run one at a time).
# When you push several commits in a row, only the newest run continues; older ones are cancelled.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Least-privilege token by default.
permissions:
  contents: read

# Consistent shell across OSes;
# Only `run.shell` / `run.working-directory` are supported here.
defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  lint:
    name: Check for formatting and linting violations (via just, uv, ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: taiki-e/install-action@d8510c9acdeaed29d14bb7104dfeb31e4b8effc8 # just
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: false
      - name: Check for formatting and linting violations
        run: just lint
  type-check:
    name: Type Checking (via just, uv, ty)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: taiki-e/install-action@d8510c9acdeaed29d14bb7104dfeb31e4b8effc8 # just
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: false
      - name: Type Checking
        run: just type-check
  test-all:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.13", "3.14"]
        resolution-strategy: ["highest", "lowest-direct"]
    name: >-
      Tests • ${{ matrix.os }} • Python ${{ matrix.python-version }}
      • resolution-strategy ${{ matrix.resolution-strategy }} (via just, uv, pytest, pytest-pretty)
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: taiki-e/install-action@d8510c9acdeaed29d14bb7104dfeb31e4b8effc8 # just
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: false
      - name: Run all the tests
        env:
          UV_RESOLUTION: ${{ matrix.resolution-strategy }}
        run: just test-ci
  coverage-xml:
    if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
    name: Send Coverage to Codecov
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
      - uses: taiki-e/install-action@d8510c9acdeaed29d14bb7104dfeb31e4b8effc8 # just
      - uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          enable-cache: false
      - name: Generating an XML Coverage Report
        run: just coverage-xml
      - name: Upload Coverage Report to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: coverage.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
