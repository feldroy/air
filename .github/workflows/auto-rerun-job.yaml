name: Auto rerun failed CI
on:
  workflow_run: # zizmor: ignore[dangerous-triggers]
    workflows: [CI]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ github.token }}
  WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}

jobs:
  job-ids:
    name: Collect failed job IDs
    if: github.event.workflow_run.conclusion != 'success' && github.event.workflow_run.run_attempt == 1
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: read
    outputs:
      ids: ${{ steps.collect-job-ids.outputs.ids }}
    steps:
      - name: Collect failed job IDs
        id: collect-job-ids
        # Job is waiting for a hosted runner to come online.
        run: |
          ids="$(
            gh run view "$WORKFLOW_RUN_ID" --json jobs --jq '
              [
                .jobs[]
                | select(.conclusion | IN("timed_out"))
                | .databaseId
              ]'
          )"
          echo "ids=$ids" >> "$GITHUB_OUTPUT"
  rerun:
    needs: job-ids
    if: ${{ needs.job-ids.outputs.ids != '[]' }}
    name: Rerun failed jobs
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: write
    strategy:
      fail-fast: false
      matrix:
        job-id: ${{ fromJson(needs.job-ids.outputs.ids) }}
    steps:
      - name: Rerun failed jobs
        env:
          JOB_ID: ${{ matrix.job-id }}
        run: gh run rerun "$WORKFLOW_RUN_ID" --failed --job "$JOB_ID"
