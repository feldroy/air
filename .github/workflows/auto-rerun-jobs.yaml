name: Auto rerun failed CI

on:
  workflow_run: # zizmor: ignore[dangerous-triggers]
    workflows: [CI]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ github.token }}
  WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}

jobs:
  job-ids:
    name: Collect failed job IDs
    if: ${{ github.event.workflow_run.conclusion == 'timed_out' && github.event.workflow_run.run_attempt == 1 }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: read
    outputs:
      ids: ${{ steps.collect-job-ids.outputs.ids }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Collect failed job IDs
        id: collect-job-ids
        run: |
          ids="$(
            gh run view "$WORKFLOW_RUN_ID" --json jobs --jq '
              [ .jobs[] | select(.conclusion == "timed_out") | .databaseId ]
            '
          )"
          echo "ids=$ids" >> "$GITHUB_OUTPUT"
  rerun:
    needs: job-ids
    if: ${{ needs.job-ids.outputs.ids != '[]' }}
    name: Rerun failed jobs
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: write
    strategy:
      fail-fast: false
      matrix:
        job-id: ${{ fromJson(needs.job-ids.outputs.ids) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Rerun failed jobs
        env:
          JOB_ID: ${{ matrix.job-id }}
        run: gh run rerun "$WORKFLOW_RUN_ID" --failed --job "$JOB_ID"
